const passport = require('passport');
const SamlStrategy = require('passport-saml').Strategy;

module.exports = (getUserByEmail) => {
  passport.use(new SamlStrategy({
    callbackUrl: 'http://localhost:3001/api/auth/saml/callback',
    entryPoint: 'https://accounts.google.com/o/saml2/idp?idpid=YOUR_IDPID', // ← CAMBIAR
    issuer: 'cruz-roja-app',
    cert: 'TU_CERTIFICADO_GOOGLE', // ← Obtener de Google Console
    privateCert: null,
    signatureAlgorithm: 'sha256'
  }, async (profile, done) => {
    try {
      const email = profile['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress'] || 
                   profile.email;
      
      const user = await getUserByEmail(email);
      
      if (!user) {
        return done(null, false, { message: 'Usuario no encontrado en Cruz Roja' });
      }
      
      return done(null, user);
    } catch (err) {
      return done(err);
    }
  }));

  passport.serializeUser((user, done) => done(null, user.id));
  passport.deserializeUser(async (id, done) => {
    try {
      const user = await getUserByEmail(id);
      done(null, user);
    } catch (err) {
      done(err);
    }
  });

  return passport;
};
